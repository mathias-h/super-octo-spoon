<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Djursland Landboforening</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.2/css/bootstrap.min.css">
    <script src="https://code.jquery.com/jquery-3.2.1.js" defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.3/umd/popper.min.js" async defer></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.2/js/bootstrap.min.js" defer></script>
    <script src="https://momentjs.com/downloads/moment.min.js" async defer></script>
    <script src="/editOrderModal.js" async defer></script>
    <link rel="stylesheet" type="text/css" href="/overviewStyle.css">
    <script defer>
        'use strict';

        function convertFormToObject(form) {
            const data = {};
            const f = new FormData(form);
            for (const [key,value] of f.entries()) {
                data[key] = value;
            }
            return data;
        }

        window.addEventListener('load', function() {
            new EditOrderModal();

            $("#inputSignedDate").val(moment(new Date()).format("YYYY-MM-DD"));
            $("#inputSignedDate").val(moment(new Date()).format("YYYY-MM-DD"));

            $("#orderCreateCancel").click(() => {
                clearOrderCreate();
            });

            $("#orderCreateClose").click(() => {
                clearOrderCreate();
            });

            $(document).keyup((e) => {
                if(e.which == 27){
                    clearOrderCreate();
                }
            });

            function clearOrderCreate(){
                // TODO: Sæt konsulent tilbage til bruger
                $("#inputSignedDate").val("2017-11-21");
                $("#inputName").val("");
                $("#inputFarmName").val("");
                $("#inputStreet").val("");
                $("#inputZip").val("");
                $("#inputCity").val("");
                $("#inputLandlineNumber").val("");
                $("#inputPhoneNumber").val("");
                $("#inputComment").val("");
            }


            const form = document.getElementById('orderCreateForm');
            form.addEventListener('submit', function(event) {
                event.preventDefault();
                event.stopPropagation();

                const landline = $("#inputLandlineNumber");
                const mobile = $("#inputPhoneNumber");

                landline[0].setCustomValidity("");
                mobile[0].setCustomValidity("");

                if(!(landline[0].validity.valid && landline.val()) && !(mobile[0].validity.valid && mobile.val())){
                    landline[0].setCustomValidity("Mindst et telefonnummer skal angives");
                    mobile[0].setCustomValidity("Mindst et telefonnummer skal angives");
                }else{
                    landline[0].setCustomValidity("");
                    mobile[0].setCustomValidity("");
                }

                if (form.checkValidity() === true) {
                    const data = convertFormToObject(form);
                    $.ajax({
                        url: "/order/create",
                        method: "POST",
                        data: JSON.stringify(data),
                        headers: {
                            "content-type": "application/json"
                        }
                    }).then(location.reload());
                }

                form.classList.add('was-validated');
            }, false);

            $(".sortable").click(function () {
                var id = $(this).attr("id");
                var ls = location.search;
                if (ls.length === 0 || (ls.indexOf("sortBy")!==-1 && ls.indexOf("query") === -1)){
                    location.search = "sortBy=" + id;
                }
                else if (ls.indexOf("query") !== -1 && ls.indexOf("sortBy") === -1){
                    location.search += "&sortBy=" + id;
                }else {
                    location.search = location.search.substring(0,location.search.indexOf("&")) + "&sortBy=" + id;
                }
            })
        });
    </script>
</head>
<body>
<nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
    </button>

    <div class="collapse navbar-collapse" id="navbarSupportedContent">
        <ul class="navbar-nav mr-auto">
            <li class="nav-item">
                <a class="nav-link" href="#" data-toggle="modal" data-target="#createOrderModal">opret ordre</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#">opret bruger</a>
            </li>
        </ul>
    </div>

    <span style="position: absolute; left: 50%; transform: translateX(-50%);" class="navbar-text justify-content-center">{{totalTaken}} / {{totalSamples}}</span>

    <form id="search" class="form-inline my-2 my-lg-0">
        <input class="form-control mr-sm-2" type="search" name="query" placeholder="search" aria-label="Search" value="{{query}}">
        <button class="btn btn-primary my-2 my-sm-0" type="submit">
            <img src="/search.svg" alt="search icon">
        </button>
    </form>
</nav>

<div id="contentData">
    <table class="table table-fixed table-striped">
        <thead>
        <tr>
            <th class="sortable" id="consultant" >konsulent</th>
            <th class="sortable" id="date">oprettet dato</th>
            <th>fastnet tlf.</th>
            <th>mobil tlf.</th>
            <th class="sortable" id="name">navn</th>
            <th class="sortable" id="address">adresse</th>
            <th>kommentar</th>
            <th>Prøve tæthed</th>
            <th>Areal</th>
            <th>Samme plan som sidst</th>
            <th>Selvudtag</th>
        </tr>
        </thead>
        <tbody>
            {{#each orders}}
                <tr class="order" data-order-id="{{_id}}">
                    <td>
                        {{consultant}}
                    </td>
                    <td>
                        {{signedDate}}
                    </td>
                    <td>
                        {{landlineNumber}}
                    </td>
                    <td>
                        {{phoneNumber}}
                    </td>
                    <td>
                        {{name}}
                    </td>
                    <td>
                        {{farmName}}, {{address.street}}, {{address.city}}, {{address.zip}}
                    </td>
                    <td>
                        {{comment}}
                    </td>
                    <td>
                        {{#if sampleDensity}}
                            1/{{sampleDensity}}ha
                        {{else}}
                            ikke sat
                        {{/if}}
                    </td>
                    <td>{{area}}ha</td>
                    <td>
                        {{#if samePlanAsLast}}
                            <img src="/check.svg" alt="flueben"/>
                        {{/if}}
                    </td>
                    <td>
                        {{#if takeOwnSamples}}
                            <img src="/check.svg" alt="flueben"/>
                        {{/if}}
                    </td>
                </tr>
            {{/each}}
        </tbody>
    </table>
</div>

<!-- Create order modal -->
<!-- Larsen comment: Hvordan håndterer vi tilføjede felter ved oprettelse? Enten må vi automatisk tilføje dem til 'Opret Ordre' blokken (forneden) eller tilføje en måde at opdatere nye kolonner -->
<div class="modal fade" id="createOrderModal" tabindex="-1" role="dialog" aria-labelledby="createOrderModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="createOrderModalLabel">Opret ordre</h5>
                <button type="button" class="close" id="orderCreateClose" data-dismiss="modal" aria-label="Close" style="cursor: pointer;">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <form id="orderCreateForm" novalidate>
                <div class="modal-body">
                    <div class="form-row">
                        <div class="col form-group">
                            <label for="inputConsultant">Konsulent</label>
                            <select name="consultant" id="inputConsultant" class="form-control" required>
                                {{#each consultants}}
                                    <option value="{{this}}">{{this}}</option>
                                {{/each}}
                            </select>
                        </div>
                        <div class="col form-group">
                            <label for="inputSignedDate">Indgået dato</label>
                            <input name="signedDate" type="date" id="inputSignedDate" class="form-control" required>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="col-9 form-group">
                            <label for="inputName">Navn</label>
                            <input name="name" type="text" id="inputName" class="form-control" placeholder="Navn" required>
                        </div>
                        <div class="col form-group">
                            <label for="inputFarmName">Gårdnavn</label>
                            <input name="farmName" type="text" id="inputFarmName" class="form-control" placeholder="Gårdnavn" required>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="col-6 form-group">
                            <label for="inputStreet">Adresse</label>
                            <input name="street" type="text" id="inputStreet" class="form-control" placeholder="Adresse" required>
                        </div>
                        <div class="col form-group">
                            <label for="inputZip">Postnummer</label>
                            <input name="zip" type="number" id="inputZip" class="form-control" placeholder="Postnummer" required>
                        </div>
                        <div class="col form-group">
                            <label for="inputCity">By</label>
                            <input name="city" type="text" id="inputCity" class="form-control" placeholder="By" required>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="col form-group">
                            <label for="inputLandlineNumber">Fastnet tlf.</label>
                            <input name="landlineNumber" type="tel" id="inputLandlineNumber" class="form-control" placeholder="Fastnet telefon" pattern="^[\s()+-]*([0-9][\s()+-]*){6,20}$">
                        </div>
                        <div class="col form-group">
                            <label for="inputPhoneNumber">Mobil tlf.</label>
                            <input name="phoneNumber" type="tel" id="inputPhoneNumber" class="form-control" placeholder="Mobil telefon" pattern="^[\s()+-]*([0-9][\s()+-]*){6,20}$">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="col form-group">
                            <label for="inputComment">Kommentarer</label>
                            <textarea name="comment" id="inputComment" class="form-control" rows="5" style="min-height: 74px"></textarea>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="col-3 form-group">
                            <label for="inputSampleDensity">Prøvetæthed</label>
                            <div class="input-group" id="sampleDensityContainer">
                                <span class="input-group-addon">1/</span>
                                <input name="sampleDensity" type="number" min="0" id="inputSampleDensity" class="form-control">
                                <span class="input-group-addon">ha</span>
                            </div>
                        </div>

                        <div class="col-3 form-group">
                            <label for="inputArea">Areal</label>
                            <div class="input-group" id="sampleDensityContainer">
                                <input name="area" type="number" min="0" id="inputArea" class="form-control">
                                <span class="input-group-addon">ha</span>
                            </div>
                        </div>

                        <div class="col-5">
                            <div class="form-group ml-3" style="line-height: 0; margin-bottom: 0px; margin-top: 32px;">
                                <label for="inputSamePlanAsLast"><input name="samePlanAsLast" type="checkbox" id="inputSamePlanAsLast"> Samme plan som sidst</label>
                                <label for="inputTakeOwnSamples"><input name="takeOwnSamples" type="checkbox" id="inputTakeOwnSamples"> Prøver selvudtaget</label>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <div class="form-row float-right">
                        <div class="col form-group">
                            <button id="orderCreateCancel" class="btn btn-secondary" data-dismiss="modal" style="cursor: pointer">Annuller</button>
                            <button type="submit" class="btn btn-primary" style="cursor: pointer;">Opret ordre</button>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

{{> editOrderModal}}

</body>
</html>